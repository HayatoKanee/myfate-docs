# 八字计算逻辑在线验证报告

本报告根据在线资料验证代码中的八字计算逻辑是否符合传统命理学规则。

---

## 一、五行旺相休囚死

### 传统规则

根据[知乎文章](https://zhuanlan.zhihu.com/p/387420938)和[百度百科](https://baike.baidu.com/item/%E4%BA%94%E8%A1%8C%E6%97%BA%E7%9B%B8%E4%BC%91%E5%9B%9A%E6%AD%BB/15406432)：

> 当令者旺，我生者相，生我者休，克我者囚，我克者死。

| 季节 | 旺 | 相 | 休 | 囚 | 死 |
|------|----|----|----|----|-----|
| 春（寅卯月） | 木 | 火 | 水 | 金 | 土 |
| 夏（巳午月） | 火 | 土 | 木 | 水 | 金 |
| 秋（申酉月） | 金 | 水 | 土 | 火 | 木 |
| 冬（亥子月） | 水 | 木 | 金 | 土 | 火 |
| 四季土旺（辰未戌丑末18天） | 土 | 金 | 火 | 木 | 水 |

### 代码实现

文件: `bazi/domain/services/wuxing_calculator.py`

```python
# 季节映射 (lines 62-75)
_MONTH_SEASONS = {
    EarthlyBranch.YIN: "春", EarthlyBranch.MAO: "春", EarthlyBranch.CHEN: "春",
    EarthlyBranch.SI: "夏", EarthlyBranch.WU: "夏", EarthlyBranch.WEI: "夏",
    EarthlyBranch.SHEN: "秋", EarthlyBranch.YOU: "秋", EarthlyBranch.XU: "秋",
    EarthlyBranch.HAI: "冬", EarthlyBranch.ZI: "冬", EarthlyBranch.CHOU: "冬",
}
```

### ✅ 验证结果：正确

代码的季节映射与传统规则一致。旺相休囚死的乘数（旺/相 1.2, 休 1.0, 囚/死 0.8）是合理的简化。

### ⚠️ 发现问题

**问题1：辰未戌丑归类不一致**

传统上辰属春、未属夏、戌属秋、丑属冬，但四季土旺（每季最后18天）时土最旺。代码将：
- 辰归春 ✓
- 未归夏 ✓
- 戌归秋 ✓
- 丑归冬 ✓

但`is_earth_dominant`参数需手动传入，无法自动判断是否处于土旺期。

---

## 二、十神计算规则

### 传统规则

根据[百度百科](https://baike.baidu.com/item/%E5%8D%81%E7%A5%9E/9532559)和[国易堂](https://www.guoyi360.com/shishen/6975.html)：

> - 生我者为印绶（正印、偏印）
> - 我生者为食伤（食神、伤官）
> - 克我者为官煞（正官、七杀）
> - 我克者为妻财（正财、偏财）
> - 同类者为比劫（比肩、劫财）

**阴阳区分**：
- 同性为"偏"（比肩、偏印、偏财、食神、七杀）
- 异性为"正"（劫财、正印、正财、伤官、正官）

### 代码实现

文件: `bazi/domain/models/shishen.py`

以甲木为例验证：
| 他干 | 关系 | 阴阳 | 十神 | 代码结果 |
|------|------|------|------|----------|
| 甲 | 同类 | 同(阳阳) | 比肩 | BI_JIAN ✓ |
| 乙 | 同类 | 异(阳阴) | 劫财 | JIE_CAI ✓ |
| 丙 | 我生 | 同(阳阳) | 食神 | SHI_SHEN ✓ |
| 丁 | 我生 | 异(阳阴) | 伤官 | SHANG_GUAN ✓ |
| 戊 | 我克 | 同(阳阳) | 偏财 | PIAN_CAI ✓ |
| 己 | 我克 | 异(阳阴) | 正财 | ZHENG_CAI ✓ |
| 庚 | 克我 | 同(阳阳) | 七杀 | QI_SHA ✓ |
| 辛 | 克我 | 异(阳阴) | 正官 | ZHENG_GUAN ✓ |
| 壬 | 生我 | 同(阳阳) | 偏印 | PIAN_YIN ✓ |
| 癸 | 生我 | 异(阳阴) | 正印 | ZHENG_YIN ✓ |

### ✅ 验证结果：正确

十神计算逻辑完全符合传统规则。

---

## 三、地支藏干比例

### 传统规则

根据[知乎文章](https://zhuanlan.zhihu.com/p/672997915)和[网易新闻](https://c.m.163.com/news/a/HRG33HHE05560B91.html)：

> 子：癸 100
> 丑：己 癸 辛 60 30 10
> 寅：甲 丙 戊 60 30 10
> 卯：乙 100
> 辰：戊 乙 癸 60 30 10
> 巳：丙 戊 庚 60 30 10
> 午：丁 己 70 30
> 未：己 丁 乙 60 30 10
> 申：庚 壬 戊 60 30 10
> 酉：辛 100
> 戌：戊 辛 丁 60 30 10
> 亥：壬 甲 70 30

### 代码实现

文件: `bazi/domain/constants/harmony.py` (lines 29-42)

| 地支 | 传统藏干比例 | 代码实现 | 对比 |
|------|-------------|----------|------|
| 子 | 癸:100 | 癸:1.0 | ✓ |
| 丑 | 己:60 癸:30 辛:10 | 己:0.5 癸:0.3 辛:0.2 | ⚠️ |
| 寅 | 甲:60 丙:30 戊:10 | 甲:0.6 丙:0.3 戊:0.1 | ✓ |
| 卯 | 乙:100 | 乙:1.0 | ✓ |
| 辰 | 戊:60 乙:30 癸:10 | 戊:0.5 乙:0.3 癸:0.2 | ⚠️ |
| 巳 | 丙:60 戊:30 庚:10 | 丙:0.6 戊:0.3 庚:0.1 | ✓ |
| 午 | 丁:70 己:30 | 丁:0.5 己:0.5 | ⚠️ |
| 未 | 己:60 丁:30 乙:10 | 己:0.5 丁:0.3 乙:0.2 | ⚠️ |
| 申 | 庚:60 壬:30 戊:10 | 庚:0.6 壬:0.3 戊:0.1 | ✓ |
| 酉 | 辛:100 | 辛:1.0 | ✓ |
| 戌 | 戊:60 辛:30 丁:10 | 戊:0.5 辛:0.3 丁:0.2 | ⚠️ |
| 亥 | 壬:70 甲:30 | 壬:0.7 甲:0.3 | ✓ |

### ⚠️ 验证结果：有差异

**发现的差异：**

1. **午**：传统70:30，代码50:50
2. **丑、辰、未、戌**：传统60:30:10，代码50:30:20

这些差异可能来自不同流派的标准。代码使用的版本也是一种常见的做法，但与主流60:30:10有差异。

**建议**：根据所采用的命理流派确认比例是否正确。

---

## 四、神煞查表

### 4.1 天乙贵人

**传统口诀**（来自[百度百科](https://baike.baidu.com/item/%E5%A4%A9%E4%B9%99%E8%B4%B5%E4%BA%BA/4717566)）：
> 甲戊庚牛羊，乙己鼠猴乡，
> 丙丁猪鸡位，壬癸蛇兔藏，
> 六辛逢马虎。

| 日干 | 天乙贵人 | 代码实现 | 验证 |
|------|----------|----------|------|
| 甲 | 丑、未 | 丑、未 | ✓ |
| 乙 | 子、申 | 子、申 | ✓ |
| 丙 | 亥、酉 | 亥、酉 | ✓ |
| 丁 | 亥、酉 | 亥、酉 | ✓ |
| 戊 | 丑、未 | 丑、未 | ✓ |
| 己 | 子、申 | 子、申 | ✓ |
| 庚 | 丑、未 | 丑、未 | ✓ |
| 辛 | 午、寅 | 午、寅 | ✓ |
| 壬 | 卯、巳 | 卯、巳 | ✓ |
| 癸 | 卯、巳 | 卯、巳 | ✓ |

### ✅ 天乙贵人：正确

---

### 4.2 天德贵人

**传统规则**（来自[知乎文章](https://zhuanlan.zhihu.com/p/11966875385)）：
> 正月天德在丁，二月在申，三月在壬...

| 月支 | 传统天德 | 代码实现 | 验证 |
|------|----------|----------|------|
| 寅月 | **丁** | 丁 | ✓ |
| 卯月 | **申**（地支！） | 庚 | ❌ |
| 辰月 | **壬** | 壬 | ✓ |
| 巳月 | **辛** | 辛 | ✓ |
| 午月 | **亥**（地支！） | 甲 | ❌ |
| 未月 | **甲** | 甲 | ✓ |
| 申月 | **癸** | 癸 | ✓ |
| 酉月 | **寅**（地支！） | 丙 | ❌ |
| 戌月 | **丙** | 丙 | ✓ |
| 亥月 | **乙** | 乙 | ✓ |
| 子月 | **巳**（地支！） | 丙 | ❌ |
| 丑月 | **庚** | 庚 | ✓ |

### ❌ 天德贵人：有错误

**严重问题**：传统天德贵人在卯、午、酉、子四个月是查**地支**而非天干！

- 卯月天德在**申**（地支）
- 午月天德在**亥**（地支）
- 酉月天德在**寅**（地支）
- 子月天德在**巳**（地支）

代码将其全部转换为天干是**错误**的。

---

### 4.3 月德贵人

**传统口诀**（来自[阐微堂](https://chanweitang.com/post/193.html)）：
> 寅午戌月生者见丙，
> 申子辰月生者见壬，
> 亥卯未月生者见甲，
> 巳酉丑月生者见庚。

| 月支 | 传统月德 | 代码实现 | 验证 |
|------|----------|----------|------|
| 寅月 | 丙 | 丙 | ✓ |
| 卯月 | 甲 | 甲 | ✓ |
| 辰月 | 壬 | 壬 | ✓ |
| 巳月 | 庚 | 庚 | ✓ |
| 午月 | 丙 | 丙 | ✓ |
| 未月 | 甲 | 甲 | ✓ |
| 申月 | 壬 | 壬 | ✓ |
| 酉月 | 庚 | 庚 | ✓ |
| 戌月 | 丙 | 丙 | ✓ |
| 亥月 | 甲 | 甲 | ✓ |
| 子月 | 壬 | 壬 | ✓ |
| 丑月 | 庚 | 庚 | ✓ |

### ✅ 月德贵人：正确

---

### 4.4 禄神

**传统口诀**（来自[阐微堂](https://chanweitang.com/post/125.html)）：
> 甲禄在寅乙在卯，丙戊丁己巳午找，
> 庚辛申酉是禄位，壬逢亥兮癸子好。

| 日干 | 传统禄神 | 代码实现 | 验证 |
|------|----------|----------|------|
| 甲 | 寅 | 寅 | ✓ |
| 乙 | 卯 | 卯 | ✓ |
| 丙 | 巳 | 巳 | ✓ |
| 丁 | 午 | 午 | ✓ |
| 戊 | 巳 | 巳 | ✓ |
| 己 | 午 | 午 | ✓ |
| 庚 | 申 | 申 | ✓ |
| 辛 | 酉 | 酉 | ✓ |
| 壬 | 亥 | 亥 | ✓ |
| 癸 | 子 | 子 | ✓ |

### ✅ 禄神：正确

---

### 4.5 羊刃

**传统查法存在争议**（来自[百度百科](https://baike.baidu.com/item/%E7%BE%8A%E5%88%83/5348232)）：

主流说法：羊刃为"禄前一位"

| 日干 | 传统羊刃(主流) | 代码实现 | 验证 |
|------|----------------|----------|------|
| 甲 | 卯 | 卯 | ✓ |
| 乙 | 寅 或 辰（争议） | **辰** | ⚠️ |
| 丙 | 午 | 午 | ✓ |
| 丁 | 巳 或 未（争议） | **未** | ⚠️ |
| 戊 | 午 | 午 | ✓ |
| 己 | 巳 或 未（争议） | **未** | ⚠️ |
| 庚 | 酉 | 酉 | ✓ |
| 辛 | 申 或 戌（争议） | **戌** | ⚠️ |
| 壬 | 子 | 子 | ✓ |
| 癸 | 亥 或 丑（争议） | **丑** | ⚠️ |

### ⚠️ 羊刃：有争议

阴干羊刃的取法有两派：
1. **《千里命稿》派**：乙刃在寅、丁己刃在巳、辛刃在申、癸刃在亥
2. **《星平会海》派**：乙刃在辰、丁己刃在未、辛刃在戌、癸刃在丑

代码采用的是**《星平会海》派**的说法（阴干羊刃在禄后一位）。这不是错误，但需要明确所采用的流派。

---

### 4.6 文昌贵人

**传统口诀**（来自[知乎文章](https://zhuanlan.zhihu.com/p/4623098558)）：
> 甲乙巳午报君知，丙戊申宫丁己鸡。
> 庚猪辛鼠壬逢虎，癸人见兔入云梯。

| 日干 | 传统文昌 | 代码实现 | 验证 |
|------|----------|----------|------|
| 甲 | 巳 | 巳 | ✓ |
| 乙 | 午 | 午 | ✓ |
| 丙 | 申 | 申 | ✓ |
| 丁 | 酉 | 酉 | ✓ |
| 戊 | 申 | 申 | ✓ |
| 己 | 酉 | 酉 | ✓ |
| 庚 | 亥 | 亥 | ✓ |
| 辛 | 子 | 子 | ✓ |
| 壬 | 寅 | 寅 | ✓ |
| 癸 | 卯 | 卯 | ✓ |

### ✅ 文昌贵人：正确

---

### 4.7 桃花、驿马、华盖、将星

**传统规则**（来自[青云居](http://www.qingyunju.com/bazi/teach8z/bazi15.htm)）：

| 年/日支 | 桃花 | 驿马 | 华盖 | 将星 |
|---------|------|------|------|------|
| 申子辰 | 酉 | 寅 | 辰 | 子 |
| 寅午戌 | 卯 | 申 | 戌 | 午 |
| 巳酉丑 | 午 | 亥 | 丑 | 酉 |
| 亥卯未 | 子 | 巳 | 未 | 卯 |

代码实现（`shensha_calculator.py`）已逐一验证，全部正确。

### ✅ 桃花、驿马、华盖、将星：正确

---

## 五、时柱起法（五鼠遁）

### 传统口诀

根据[算准网](https://www.suanzhun.net/article/2409.html)：
> 甲己还加甲，乙庚丙作初，
> 丙辛从戊起，丁壬庚子居，
> 戊癸何方发，壬子是真途。

| 日干 | 子时起始 | 代码公式 | 验证 |
|------|----------|----------|------|
| 甲、己 | 甲子 | (0×2+0)%10=0 → 甲 | ✓ |
| 乙、庚 | 丙子 | (1×2+0)%10=2 → 丙 | ✓ |
| 丙、辛 | 戊子 | (2×2+0)%10=4 → 戊 | ✓ |
| 丁、壬 | 庚子 | (3×2+0)%10=6 → 庚 | ✓ |
| 戊、癸 | 壬子 | (4×2+0)%10=8 → 壬 | ✓ |

代码实现（`sexagenary_calculator.py:235`）：
```python
hour_stem_index = (day_stem_index * 2 + hour_branch_index) % 10
```

### ✅ 时柱起法：正确

---

## 六、六合与五合

### 传统规则

**六合**：子丑合、寅亥合、卯戌合、辰酉合、巳申合、午未合

**五合**：甲己合、乙庚合、丙辛合、丁壬合、戊癸合

### 代码实现

文件: `bazi/domain/constants/harmony.py`

```python
LIU_HE = frozenset([
    ('子', '丑'), ('丑', '子'),
    ('寅', '亥'), ('亥', '寅'),
    ('卯', '戌'), ('戌', '卯'),
    ('辰', '酉'), ('酉', '辰'),
    ('巳', '申'), ('申', '巳'),
    ('午', '未'), ('未', '午'),
])

WU_HE = frozenset([
    ('甲', '己'), ('己', '甲'),
    ('乙', '庚'), ('庚', '乙'),
    ('丙', '辛'), ('辛', '丙'),
    ('丁', '壬'), ('壬', '丁'),
    ('戊', '癸'), ('癸', '戊'),
])
```

### ✅ 六合与五合：正确

---

## 总结

### 验证通过 ✅

| 模块 | 状态 |
|------|------|
| 五行旺相休囚死 | ✅ 正确 |
| 十神计算规则 | ✅ 正确 |
| 天乙贵人 | ✅ 正确 |
| 月德贵人 | ✅ 正确 |
| 禄神 | ✅ 正确 |
| 文昌贵人 | ✅ 正确 |
| 桃花/驿马/华盖/将星 | ✅ 正确 |
| 时柱起法（五鼠遁） | ✅ 正确 |
| 六合与五合 | ✅ 正确 |

### 需要修复 ❌

| 模块 | 问题 |
|------|------|
| **天德贵人** | 卯、午、酉、子四个月应查地支而非天干 |

### 有差异或争议 ⚠️

| 模块 | 说明 |
|------|------|
| 藏干比例 | 午、丑、辰、未、戌的比例与主流60:30:10有差异 |
| 羊刃（阴干） | 采用《星平会海》派，与《千里命稿》派不同 |
| 土旺期判断 | 需手动传参，无法自动判断 |

---

## 修复建议

### 1. 天德贵人修复

```python
# 天德贵人应同时支持天干和地支
_TIAN_DE_GAN: Dict[EarthlyBranch, HeavenlyStem] = {
    EarthlyBranch.YIN: HeavenlyStem.DING,
    EarthlyBranch.CHEN: HeavenlyStem.REN,
    EarthlyBranch.SI: HeavenlyStem.XIN,
    EarthlyBranch.WEI: HeavenlyStem.JIA,
    EarthlyBranch.SHEN: HeavenlyStem.GUI,
    EarthlyBranch.XU: HeavenlyStem.BING,
    EarthlyBranch.HAI: HeavenlyStem.YI,
    EarthlyBranch.CHOU: HeavenlyStem.GENG,
}

_TIAN_DE_ZHI: Dict[EarthlyBranch, EarthlyBranch] = {
    EarthlyBranch.MAO: EarthlyBranch.SHEN,  # 卯月天德在申
    EarthlyBranch.WU: EarthlyBranch.HAI,    # 午月天德在亥
    EarthlyBranch.YOU: EarthlyBranch.YIN,   # 酉月天德在寅
    EarthlyBranch.ZI: EarthlyBranch.SI,     # 子月天德在巳
}
```

### 2. 藏干比例统一

建议采用主流60:30:10比例：
```python
HIDDEN_GAN_RATIOS = {
    '午': {'丁': 0.7, '己': 0.3},  # 修改
    '丑': {'己': 0.6, '癸': 0.3, '辛': 0.1},  # 修改
    # ...
}
```

---

## 参考资料

- [五行旺相休囚死 - 知乎](https://zhuanlan.zhihu.com/p/387420938)
- [十神 - 百度百科](https://baike.baidu.com/item/%E5%8D%81%E7%A5%9E/9532559)
- [天乙贵人 - 百度百科](https://baike.baidu.com/item/%E5%A4%A9%E4%B9%99%E8%B4%B5%E4%BA%BA/4717566)
- [天德月德贵人 - 知乎](https://zhuanlan.zhihu.com/p/11966875385)
- [禄神查法 - 阐微堂](https://chanweitang.com/post/125.html)
- [羊刃 - 百度百科](https://baike.baidu.com/item/%E7%BE%8A%E5%88%83/5348232)
- [文昌贵人 - 知乎](https://zhuanlan.zhihu.com/p/4623098558)
- [五鼠遁 - 算准网](https://www.suanzhun.net/article/2409.html)
- [地支藏干 - 知乎](https://zhuanlan.zhihu.com/p/672997915)
